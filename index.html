<!DOCTYPE html>
<html>
  <head>
    <title>Raycasting</title>
    <script src="state.js"></script>
    <script src="draw.js"></script>
  </head>
  <body>
    <div class="control-panel">
      <button id="shadows-button" class="selected">Shadows</button>
      <button id="spirograph-button">Spirograph</button>
      <button id="line-of-sight-button">Line of Sight</button>
      <span>Detail: <span id="detail-label" class="control-label"></span></span>
      <span>+/-: control detail level.</span>
      <span>Click: draw.</span>
      <span>ESC: cancel input.</span>
      <span>1: box. 2: circle.</span>
      <span>WASD: move LoS origin.</span>
    </div>
    <canvas></canvas>
    <style>
      html {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
      }
      body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
        overflow: hidden;
        color: #839496;
        background-color: #073642;
      }
      canvas {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
      }
      button {
        font-size: 100%;
        font-family: inherit;
        padding: 4px;
        margin: 4px;
        border: 0;
        border-color: #93a1a1;
        border-radius: 0;
        border-width: 1px;
        background-color: #657b83;
      }
      button.selected {
        background-color: #eee8d5;
      }
      .control-label {
        color: #eee8d5;
      }
    </style>
    <script>
      const canvas = document.querySelector('canvas');
      const g = canvas.getContext('2d');
      const detailLabel = document.getElementById('detail-label');
      const resize = () => {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        draw(g, canvas.width, canvas.height);
      };
      const refreshDetail = () => {
        if (mode === 'shadows') {
          detailLabel.innerHTML = '' + shadowDetail;
        } else if (mode === 'spirograph') {
          detailLabel.innerHTML = '' + spiroDetail;
        } else {
          detailLabel.innerHTML = 'N/A';
        }
      };
      refreshDetail();
      console.log(document.body.onresize); // This somehow allows onresize to work
      document.body.onresize = resize;
      resize();
      canvas.onmousemove = ({ offsetX, offsetY }) =>
        draw(g, canvas.width, canvas.height, { x: offsetX, y: offsetY });
      canvas.onmouseleave = () =>
        draw(g, canvas.width, canvas.height);
      canvas.onmousedown = ({ offsetX, offsetY }) => {
        if (input === undefined) {
          input = { x: offsetX, y: offsetY };
        } else {
          if (selectedShape === 'box') {
            boxes.push(inputShape(offsetX, offsetY));
          } else if (selectedShape === 'circle') {
            circles.push(inputShape(offsetX, offsetY));
          }
          input = undefined;
        }
        resize();
      };
      const PLUS = 187;
      const MINUS = 189;
      const ONE = 49;
      const TWO = 50;
      const ESC = 27;
      const W = 87;
      const A = 65;
      const S = 83;
      const D = 68;
      document.onkeyup = ({ keyCode }) => {
        if (keyCode === PLUS) {
          if (mode === 'shadows') {
            if (shadowDetail < 4096) {
              setShadowDetail(shadowDetail * 2);
            }
          } else if (mode === 'spirograph') {
            if (spiroDetail < 4096) {
              setSpiroDetail(spiroDetail * 2);
            }
          }
          refreshDetail();
        } else if (keyCode === MINUS) {
          if (mode === 'shadows') {
            if (shadowDetail > 2) {
              setShadowDetail(Math.floor(shadowDetail / 2));
            }
          } else if (mode === 'spirograph') {
            if (spiroDetail > 2) {
              setSpiroDetail(Math.floor(spiroDetail / 2));
            }
          }
          refreshDetail();
        } else if (keyCode === ONE) {
          selectedShape = 'box';
        } else if (keyCode === TWO) {
          selectedShape = 'circle';
        } else if (keyCode === ESC) {
          input = undefined;
        } else if (keyCode === W) {
          target.y = Math.max(0, target.y - 50);
        } else if (keyCode === A) {
          target.x = Math.max(0, target.x - 50);
        } else if (keyCode === S) {
          target.y = Math.min(canvas.clientHeight, target.y + 50);
        } else if (keyCode === D) {
          target.x = Math.min(canvas.clientWidth, target.x + 50);
        } else {
          console.log(`unknown keyCode: ${keyCode}`);
        }
        resize();
      };
      const switchMode = modeName => () => {
        document.getElementById(mode + '-button').classList.remove('selected');
        document.getElementById(modeName + '-button').classList.add('selected');
        mode = modeName;
        resize();
        refreshDetail();
      };
      const modeNames = [
        'shadows',
        'line-of-sight',
        'spirograph'
      ];
      for (const modeName of modeNames) {
        document.getElementById(modeName + '-button').onclick = switchMode(modeName);
      }
    </script>
  </body>
</html>
